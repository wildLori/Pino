<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-fences-math .MathJax_SVG_Display, .md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: visible; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; zoom: 90%; }
#math-inline-preview-content { zoom: 1.1; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-require-zoom-fix foreignobject { font-size: var(--mermaid-font-zoom); }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-math .MathJax_SVG_Display { margin-top: 8px; cursor: default; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


html {
	font-size: 19px;
}

html, body {
	margin: auto;
	background: #fefefe;
}
body {
	font-family: "Vollkorn", Palatino, Times;
	color: #333;
	line-height: 1.4;
	text-align: justify;
}

#write {
	max-width: 960px;
	margin: 0 auto;
	margin-bottom: 2em;
	line-height: 1.53;
	padding-top: 40px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1100px;
	}
}

@media print {
	html {
		font-size: 13px;
	}
}

/* Typography
-------------------------------------------------------- */

#write>h1:first-child,
h1 {
	margin-top: 1.6em;
	font-weight: normal;
}

h1 {
	font-size:3em;
}

h2 {
	margin-top:2em;
	font-weight: normal;
}

h3 {
	font-weight: normal;
	font-style: italic;
	margin-top: 3em;
}

h1, 
h2, 
h3{
	text-align: center;
}

h2:after{
	border-bottom: 1px solid #2f2f2f;
    content: '';
    width: 100px;
    display: block;
    margin: 0 auto;
    height: 1px;
}

h1+h2, h2+h3 {
	margin-top: 0.83em;
}

p,
.mathjax-block {
	margin-top: 0;
	-webkit-hypens: auto;
	-moz-hypens: auto;
	hyphens: auto;
}
ul {
	list-style: square;
	padding-left: 1.2em;
}
ol {
	padding-left: 1.2em;
}
blockquote {
	margin-left: 1em;
	padding-left: 1em;
	border-left: 1px solid #ddd;
}
code,
pre {
	font-family: "Consolas", "Menlo", "Monaco", monospace, serif;
	font-size: .9em;
	background: white;
}
.md-fences{
	margin-left: 1em;
	padding-left: 1em;
	border: 1px solid #ddd;
	padding-bottom: 8px;
	padding-top: 6px;
	margin-bottom: 1.5em;
}

a {
	color: #2484c1;
	text-decoration: none;
}
a:hover {
	text-decoration: underline;
}
a img {
	border: none;
}
h1 a,
h1 a:hover {
	color: #333;
	text-decoration: none;
}
hr {
	color: #ddd;
	height: 1px;
	margin: 2em 0;
	border-top: solid 1px #ddd;
	border-bottom: none;
	border-left: 0;
	border-right: 0;
}
.ty-table-edit {
	background: #ededed;
    padding-top: 4px;
}
table {
	margin-bottom: 1.333333rem
}
table th,
table td {
	padding: 8px;
	line-height: 1.333333rem;
	vertical-align: top;
	border-top: 1px solid #ddd
}
table th {
	font-weight: bold
}
table thead th {
	vertical-align: bottom
}
table caption+thead tr:first-child th,
table caption+thead tr:first-child td,
table colgroup+thead tr:first-child th,
table colgroup+thead tr:first-child td,
table thead:first-child tr:first-child th,
table thead:first-child tr:first-child td {
	border-top: 0
}
table tbody+tbody {
	border-top: 2px solid #ddd
}

.task-list{
	padding:0;
}

.md-task-list-item {
	padding-left: 1.6rem;
}

.md-task-list-item > input:before {
	content: '\221A';
	display: inline-block;
	width: 1.33333333rem;
  	height: 1.6rem;
	vertical-align: middle;
	text-align: center;
	color: #ddd;
	background-color: #fefefe;
}

.md-task-list-item > input:checked:before,
.md-task-list-item > input[checked]:before{
	color: inherit;
}
.md-tag {
	color: inherit;
	font: inherit;
}
#write pre.md-meta-block {
	min-height: 35px;
	padding: 0.5em 1em;
}
#write pre.md-meta-block {
	white-space: pre;
	background: #f8f8f8;
	border: 0px;
	color: #999;
	
	width: 100vw;
	max-width: calc(100% + 60px);
	margin-left: -30px;
	border-left: 30px #f8f8f8 solid;
	border-right: 30px #f8f8f8 solid;

	margin-bottom: 2em;
	margin-top: -1.3333333333333rem;
	padding-top: 26px;
	padding-bottom: 10px;
	line-height: 1.8em;
	font-size: 0.9em;
	font-size: 0.76em;
	padding-left: 0;
}
.md-img-error.md-image>.md-meta{
	vertical-align: bottom;
}
#write>h5.md-focus:before {
	top: 2px;
}

.md-toc {
	margin-top: 40px;
}

.md-toc-content {
	padding-bottom: 20px;
}

.outline-expander:before {
	color: inherit;
	font-size: 14px;
	top: auto;
	content: "\f0da";
	font-family: FontAwesome;
}

.outline-expander:hover:before,
.outline-item-open>.outline-item>.outline-expander:before {
  	content: "\f0d7";
}

/** source code mode */
#typora-source {
	font-family: Courier, monospace;
    color: #6A6A6A;
}

.html-for-mac #typora-sidebar {
    -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, .175);
    box-shadow: 0 6px 12px rgba(0, 0, 0, .175);
}

.cm-s-typora-default .cm-header, 
.cm-s-typora-default .cm-property,
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor {
	color: #428bca;
}

.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number {
	color: #777777;
}

.typora-node .file-list-item-parent-loc, 
.typora-node .file-list-item-time, 
.typora-node .file-list-item-summary {
	font-family: arial, sans-serif;
}

.md-task-list-item>input {
    margin-left: -1.3em;
    margin-top: calc(1rem - 12px);
}

.md-mathjax-midline {
	background: #fafafa;
}

.md-fences .code-tooltip {
	bottom: -2em !important;
}

.dropdown-menu .divider {
	border-color: #e5e5e5;
}

 :root {--mermaid-font-zoom:1.5em ;} 
</style><title>README</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><p float="left">
	<img src=".\assets\logoisii.webp" alt="logoisii" style="zoom:45%;"></p><h1 id='belfanti-lorenzo-5f-informatica'><span>Belfanti Lorenzo, 5^F Informatica </span></h1><h1 id='esame-di-stato-20202021'><span>Esame di Stato 2020/2021 </span></h1><h3 id='indice-dei-contenuti'><span>Indice dei contenuti</span></h3><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1488"><a class="md-toc-inner" href="#belfanti-lorenzo-5f-informatica">Belfanti Lorenzo, 5^F Informatica </a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3"><a class="md-toc-inner" href="#esame-di-stato-20202021">Esame di Stato 2020/2021 </a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4"><a class="md-toc-inner" href="#indice-dei-contenuti">Indice dei contenuti</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n7"><a class="md-toc-inner" href="#1-contesto">1. Contesto</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n9"><a class="md-toc-inner" href="#11---as-is--situazione-attuale">1.1 - As Is : Situazione Attuale</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n38"><a class="md-toc-inner" href="#12---to-be--obiettivi-di-progetto">1.2 - To Be : Obiettivi di Progetto</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n75"><a class="md-toc-inner" href="#13---considerazioni--soluzioni-attuali">1.3 - Considerazioni : Soluzioni Attuali</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n104"><a class="md-toc-inner" href="#2-ciclo-di-sviluppo">2. Ciclo di Sviluppo</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n114"><a class="md-toc-inner" href="#21---pianificazione-attività--piano-di-lavoro">2.1 - Pianificazione attività / Piano di lavoro</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n171"><a class="md-toc-inner" href="#22---hosting-e-mantenimento-progetto">2.2 - Hosting e Mantenimento Progetto</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n187"><a class="md-toc-inner" href="#3---progettazione-rete">3. - Progettazione Rete</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n188"><a class="md-toc-inner" href="#31---componenti-rete">3.1 - Componenti Rete</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n226"><a class="md-toc-inner" href="#32---rete-locale">3.2 - Rete Locale </a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n284"><a class="md-toc-inner" href="#33---interfacciamento-con-rete-esterna">3.3 - Interfacciamento con Rete Esterna</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n286"><a class="md-toc-inner" href="#331---dynamicdns">3.3.1 - DynamicDNS</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n295"><a class="md-toc-inner" href="#332---certificati">3.3.2 - Certificati</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n317"><a class="md-toc-inner" href="#4-componenti-hardware">4. Componenti Hardware</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n319"><a class="md-toc-inner" href="#41---server">4.1 - Server</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n343"><a class="md-toc-inner" href="#42---sensori-smart">4.2 - Sensori Smart</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n355"><a class="md-toc-inner" href="#411---shelly-1">4.1.1 - Shelly 1</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n386"><a class="md-toc-inner" href="#413---shelly-em">4.1.3 - Shelly EM</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n424"><a class="md-toc-inner" href="#414---installazione-sensori-nellimpianto-elettrico">4.1.4 - Installazione Sensori nell'impianto elettrico</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n482"><a class="md-toc-inner" href="#5-componenti-software">5. Componenti Software</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n593"><a class="md-toc-inner" href="#51---database">5.1 - Database</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n610"><a class="md-toc-inner" href="#511---struttura-base-di-dati">5.1.1 - Struttura Base di Dati</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n637"><a class="md-toc-inner" href="#512---query-rilevanti">5.1.2 - Query Rilevanti</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n640"><a class="md-toc-inner" href="#513---accesso-al-db">5.1.3 - Accesso al DB</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n644"><a class="md-toc-inner" href="#52---shelly--iot-logic">5.2 - Shelly &amp; IoT Logic</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n655"><a class="md-toc-inner" href="#521---configurazione-http">5.2.1 - Configurazione HTTP</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n677"><a class="md-toc-inner" href="#522-ricezione-shelly">5.2.2 Ricezione Shelly</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n681"><a class="md-toc-inner" href="#53---ha-core">5.3 - HA-Core</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n683"><a class="md-toc-inner" href="#531---anatomia-dellambiente-di-sviluppo-ha">5.3.1 - Anatomia dell'ambiente di sviluppo HA</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n686"><a class="md-toc-inner" href="#532---configurazione-ambiente-di-sviluppo">5.3.2 - Configurazione ambiente di sviluppo</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n709"><a class="md-toc-inner" href="#533-interfaccia-programmazione-ha">5.3.3 Interfaccia Programmazione HA</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n736"><a class="md-toc-inner" href="#534-automazione-interruzione--integrazione-con-alexa">5.3.4 Automazione Interruzione &amp; Integrazione con Alexa</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n769"><a class="md-toc-inner" href="#535---monitoraggio-dashboard">5.3.5 - Monitoraggio Dashboard</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n784"><a class="md-toc-inner" href="#54---pwa-admin">5.4 - PWA Admin </a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n799"><a class="md-toc-inner" href="#541---web-push">5.4.1 - Web-Push</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n810"><a class="md-toc-inner" href="#542---flusso-del-webpush">5.4.2 - Flusso del WebPush</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n842"><a class="md-toc-inner" href="#544---controllo-bash">5.4.4 - Controllo Bash</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n846"><a class="md-toc-inner" href="#55---proxy-e-sicurezza">5.5 - Proxy e Sicurezza</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n865"><a class="md-toc-inner" href="#56---backup">5.6 - Backup</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n870"><a class="md-toc-inner" href="#561---script--automatizzazione">5.6.1 - Script &amp; Automatizzazione</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n909"><a class="md-toc-inner" href="#6---roadmap-successiva">6 - Roadmap successiva</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n923"><a class="md-toc-inner" href="#61---ri-collocamento-server-locale">6.1 - Ri-collocamento Server Locale</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n939"><a class="md-toc-inner" href="#62---installazione-in-container">6.2 - Installazione in Container</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n949"><a class="md-toc-inner" href="#63---migrazione-db-in-cloud">6.3 - Migrazione DB in Cloud</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n968"><a class="md-toc-inner" href="#64---richieste-esplicite-verso-alexa">6.4 - Richieste esplicite verso Alexa</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n995"><a class="md-toc-inner" href="#7---note--conclusioni">7 - Note &amp; Conclusioni</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1090"><a class="md-toc-inner" href="#71---strumenti-software-impiegati">7.1 - Strumenti Software Impiegati</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1035"><a class="md-toc-inner" href="#72---fonti">7.2 - Fonti</a></span></p></div><p><img src=".\assets\logo_type.svg" referrerpolicy="no-referrer"></p><h2 id='1-contesto'><span>1. Contesto</span></h2><p><span>L&#39;idea del progetto nasce dall&#39;esigenza di </span><strong><span>acquisire coscienza dei consumi</span></strong><span> </span><strong><span>elettrici</span></strong><span>  e dalla volontà di prevenire le interruzioni del servizio da parte di Enel per superamento della soglia di potenza garantita dal contratto.</span></p><h3 id='11---as-is--situazione-attuale'><span>1.1 - As Is : Situazione Attuale</span></h3><p><span>Attualmente un abitazione con contratto tradizionale per la fornitura elettrica presenta dei vincoli : </span></p><ul><li><p><strong><span>Costo</span></strong><span> </span><strong><span>dell&#39;energia elettrica variabile per Fascia Oraria</span></strong><span> (F1,F2,F3).</span>
<span>Ogni fascia oraria presenta un prezzo al Kw differente:</span></p><figure><table><thead><tr><th><span>Fascia</span></th><th><span>Periodo e Durata</span></th><th><span>Prezzo</span></th></tr></thead><tbody><tr><td><span>F1</span></td><td><span>Lunedì-Venerdì dalle ore 8.00 alle 19.00</span></td><td><span>€€€</span></td></tr><tr><td><span>F2</span></td><td><span>Lunedì-Venerdì dalle 7.00 alle 8.00 e dalle 19.00 alle 23.00</span></td><td><span>€€</span></td></tr><tr><td><span>F3</span></td><td><span>Lunedì-Sabato dalle 23.00 alle 7.00 + domenica e giorni festivi 24/24h</span></td><td><span>€</span></td></tr></tbody></table></figure><p>&nbsp;</p></li><li><p><strong><span>Soglia di erogazione elettrica massima</span></strong><span> fissata a 3 KW</span></p><p><span>Coi nuovi contatori della luce è stata introdotta una tolleranza grazie alla quale è possibile </span><strong><span>avere più energia di quella nominale di contratto per un limitato periodo di tempo</span></strong><span> evitando che venga interrotto improvvisamente il servizio.</span></p></li></ul><blockquote><p><span>Il consumo in tempo reale è quindi visibile dal solo contatore fisico (dislocato rispetto alla zona vivibile dell&#39;abitazione)</span></p></blockquote><h3 id='12---to-be--obiettivi-di-progetto'><span>1.2 - To Be : Obiettivi di Progetto</span></h3><p><span>Gli obiettivi di progetto sono 3+1:</span></p><figure><table><thead><tr><th style='text-align:center;' ><span>Obiettivi:</span></th></tr></thead><tbody><tr><td style='text-align:center;' ><span>Monitoraggio</span></td></tr><tr><td style='text-align:center;' ><span>Azioni di Protezione e Prevenzione</span></td></tr><tr><td style='text-align:center;' ><span>Notifica e Avviso</span></td></tr></tbody></table></figure><ul><li><p><strong><span>Monitoraggio</span></strong></p><ul><li><span>Raccolta dei dati sui consumi </span></li><li><span>Generazione di </span><strong><span>Reportistica in formato CSV / XLSX</span></strong></li></ul></li><li><p><strong><span>Azioni di Protezione e Prevenzione</span></strong></p><ul><li><span>Disattivazione programmatica di apparecchi che superano la soglia di consumo nominale</span></li><li><span>Regolazione programmatica della modalità di consumi dei dispositivi laddove essi espongano una interfaccia di regolazione (esempio Forno IoT)</span></li></ul></li><li><p><strong><span>Notifica e Avviso</span></strong><span> </span>
<em><span>Le precedenti azioni di protezione e prevenzione devono essere segnalate in modo da conoscere </span><strong><span>sempre e istantaneamente</span></strong><span> la causa di un determinato evento.</span></em></p><ul><li><span>Notifica su cellulare dei famigliari, indipendentemente dalla loro posizione.</span></li><li><span>Notifica acustica attraverso gli Smart Speaker presenti in una abitazione (es. Alexa o Google Assistant).</span></li></ul></li><li><p><u><strong><span>Extra : Gamification</span></strong></u></p><p><em><span>Le meccaniche di </span><strong><span>Gamification</span></strong><span> devono incentivare una serie di azioni e comportamenti volte al risparmio e l&#39;utilizzo consapevole dell&#39;energia elettrica.</span></em></p></li></ul><p>&nbsp;</p><h3 id='13---considerazioni--soluzioni-attuali'><span>1.3 - Considerazioni : Soluzioni Attuali</span></h3><p><span>Esistono già applicativi software che potrebbero essere impiegati, tra cui:</span></p><figure><table><thead><tr><th><span>Nome Soluzione</span></th><th><span>Vantaggi / Features</span></th><th><span>Svantaggi</span></th></tr></thead><tbody><tr><td><span>Home Assistant Complete Edition</span></td><td><span>- Monitoraggio completo di infrastruttura IoT</span><br><span>- Buon </span><strong><span>supporto e assistenza</span></strong></td><td><span>- Pre-bundled (contiene elementi software aggiuntivi superflui)</span><br><span>- </span><br><br></td></tr><tr><td><span>Shelly Cloud</span></td><td><span>- Controllo Remoto tramite Cloud proprietario</span></td><td><span>- </span><strong><span>Interfaccia</span></strong><span> applicazione non soddisfacente</span><br><span>- Poche </span><strong><span>azioni</span></strong><span> possibili</span><br><span>- Cloud terzo funzionante con </span><strong><span>Polling</span></strong></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></figure><p><span>In sostanza, questi applicativi potrebbero funzionare ma non risolvono in toto le esigenze proposte :</span>
<span>In particolare:</span></p><ul><li><strong><span>REPORTISTICA ESPORTABILE</span></strong><span>: Non offrono di base un sistema per esportare</span></li><li><strong><span>CROSS-PLATFORM</span></strong><span> : Possibilità di utilizzo del software di Gestione da qualsiasi piattaforma</span></li><li><strong><span>NOTIFICA</span></strong><span> : Possibilità di ricezione notifica su </span><strong><span>cellulare</span></strong><span> e </span><strong><span>notifica integrata con dispositivo Amazon Alexa</span></strong><span> già presente nell&#39;applicazione</span></li></ul><p><span>Vi è quindi la necessità dello sviluppo di </span><strong><span>un sistema su misura.</span></strong></p><p>&nbsp;</p><h2 id='2-ciclo-di-sviluppo'><span>2. Ciclo di Sviluppo</span></h2><p><span>Il ciclo di Sviluppo comincia con una fase preliminare di identificazione dei </span><strong><span>Core Goal:</span></strong></p><p><span>Dai paragrafi precedenti si apprende che i requisiti funzionali siano rappresentati da:</span></p><ul><li><span>Consultazione consumi tramite smartphone</span></li><li><span>Notifica Vocale tramite Smart Speaker</span></li><li><span>Azione di disattivazione automatica per prevenzione taglio corrente</span></li></ul><h3 id='21---pianificazione-attività--piano-di-lavoro'><span>2.1 - Pianificazione attività / Piano di lavoro</span></h3><p><span>Con la seguente vengono indicate le fasi del ciclo di sviluppo del progetto</span></p><ol start='' ><li><p><strong><span>Preparazione</span></strong></p><ol start='' ><li><span>Analisi dei Requisiti Funzionali</span></li><li><span>Analisi Requisiti Non Funzionali</span></li><li><span>Confronto con Stakeholders</span></li></ol></li><li><p><strong><span>Progettazione</span></strong></p><ol start='' ><li><span>Definizione Schema di Rete</span></li><li><span>Definizione Interazione tra attori del sistema</span></li><li><span>Definizione Schema DB</span></li><li><span>Wire-frame Interfaccia</span></li></ol></li><li><p><strong><span>Configurazione Sistema</span></strong></p><ol start='' ><li><span>Setup di Rete</span></li><li><span>Configurazione Hardware e Sensori</span></li></ol></li><li><p><strong><span>Scrittura Codice</span></strong></p><ol start='' ><li><span>Scrittura Interfaccia Sensori</span></li><li><span>Scrittua Model Manager DB</span></li><li><span>Configurazione Software gestionale</span></li><li><span>Integrazione con Smart Speaker</span></li><li><span>Creazione Interfaccia</span></li></ol></li><li><p><strong><span>Testing</span></strong></p><ol start='' ><li><span>Test di errori sistema</span></li><li><span>Analisi dei log</span></li></ol></li><li><p><strong><span>Integrazione Continua</span></strong></p><ol start='' ><li><span>Iterazione di confronti con Stakeholders</span></li></ol></li></ol><p><span>In generale lo sviluppo del progetto in questione non è lineare e si è preferisce una metodologia AGILE con un confronto diretto con lo stakeholder (in questo caso, famigliari).</span></p><p><span>Attenzione il passaggio del confronto con gli stakeholder rappresenta una opportunità importante di scremare ciò che è importante e cosa non lo è, </span><strong><span>con conseguenti modifiche alla roadmap.</span></strong></p><h3 id='22---hosting-e-mantenimento-progetto'><span>2.2 - Hosting e Mantenimento Progetto</span></h3><p><strong><span>L&#39;hosting</span></strong><span> avviene in locale (vedasi riferimenti a Server e Rete).</span></p><p><span>Il </span><strong><span>Codice sorgente</span></strong><span> del progetto è mantenuto in una </span><strong><span>repository privata di Github.</span></strong>
<span>Sono volutamente ignorati i file :</span></p><ul><li><span>Log</span></li><li><span>Node Modules</span></li><li><span>Certificati e Chiavi</span></li><li><span>Pip Modules</span></li><li><span>Database .db </span></li></ul><p><span>Per questioni di sicurezza questi vengono archiviati separatamente (vedasi sezione Backup).</span></p><p>&nbsp;</p><h2 id='3---progettazione-rete'><span>3. - Progettazione Rete</span></h2><h3 id='31---componenti-rete'><span>3.1 - Componenti Rete</span></h3><figure><table><thead><tr><th style='text-align:center;' ><span>Configurazioni richieste:</span></th></tr></thead><tbody><tr><td style='text-align:center;' ><span>Impostazione firewall </span><strong><span>router</span></strong><span> e firewall </span><strong><span>client</span></strong></td></tr><tr><td style='text-align:center;' ><span>Impostazione </span><strong><span>rotte</span></strong><span> </span><strong><span>statiche</span></strong><span> nella rete locale</span></td></tr><tr><td style='text-align:center;' ><strong><span>Port Forwarding</span></strong><span> nella rete locale</span></td></tr><tr><td style='text-align:center;' ><span>Dynamic </span><strong><span>DNS</span></strong></td></tr><tr><td style='text-align:center;' ><span>Certificato </span><strong><span>SSL</span></strong></td></tr></tbody></table></figure><ol start='' ><li><p><u><span>Firewall di </span><strong><span>Rete</span></strong><span> e </span><strong><span>Firewall Client</span></strong><span>:</span></u>
<span>La configurazione deve avvenire su </span><strong><span>entrambi</span></strong><span> affinchè non vengano </span><strong><span>bloccate</span></strong><span> le comunicazioni, e che al tempo stesso non si esponga la propria rete locale a </span><strong><span>minacce esterne.</span></strong></p><blockquote><p><em><span>*NOTA : una soluzione più sicura è rappresentata dall&#39;impiego di un tunneling diretto via VPN tra l&#39;esterno e la propria rete locale, tuttavia richiede una configurazione lato client più complessa.</span></em></p></blockquote></li><li><p><u><strong><span>Apertura</span></strong><span> e </span><strong><span>Forwarding</span></strong><span> delle porte del Router:</span></u>
<span>L&#39;operazione è </span><strong><span>necessaria</span></strong><span> affinchè si possano accogliere chiamate provenienti dall&#39;esterno. </span>
<span>Le porte di un Router </span><strong><span>non Enterprise</span></strong><span> sono </span><strong><span>chiuse</span></strong><span> di Default. </span></p><blockquote><p><span>La procedura può variare a seconda del modello utilizzato.</span>
<span>Vedasi la sezione seguente per l&#39;elenco delle porte aperte e dei relativi forwarding.</span></p></blockquote></li><li><p><u><span>Impostazione di </span><strong><span>rotte statiche dei client nella Rete Locale</span></strong><span> :</span></u>
<span>L&#39;operazione è necessaria affinchè il </span><strong><span>port-forwarding</span></strong><span> possa avvenire correttamente. </span><em><span>(Ad esempio, essere sicuri che una chiamata sulla porta 8080 venga inoltrata al Server di Casa e non ad altri dispositivi)</span></em>
<span>E&#39; quindi necessario identificare univocamente un dispositivo nella rete locale. </span>
<span>Lo scopo può essere raggiunto in due modi:</span></p><ul><li><span>Assegnazione </span><strong><span>IP Statico</span></strong></li><li><span>Utilizzo del </span><strong><span>MAC Address</span></strong><span> come identificatore univoco nella rete locale</span></li></ul></li><li><p><u><span>Registrazione e Impostazione di un </span><strong><span>dynamicDNS</span></strong></u>
<em><span>Il provider di servizi Internet, </span><strong><span>se non in condizioni enterprise o di esplicita richiesta</span></strong><span>, fornisce un IP dinamico ad ogni nuova connessione (ad esempio dopo uno spegnimento del router).</span></em>
<span>Affinchè si possa </span><strong><span>raggiungere sempre una rete che ha indirizzo IP dinamico</span></strong><span> è necessario appoggiarsi a un </span><strong><span>provider di Servizi dynDNS (DNS dinamico)</span></strong><span> e attivare la connessione a tale servizio nel Router della Rete Locale. Così facendo, ogni volta che il Router ottiene un nuovo indirizzo IP, questo viene comunicato al server DNS che aggiorna l&#39;indirizzo a cui punta un dato dominio </span><a href='http://www.mio-dominio.com' target='_blank' class='url'>www.mio-dominio.com</a></p></li><li><p><u><span>Richiesta </span><strong><span>Certificato SSL</span></strong></u>
<span>Il </span><strong><span>certificato SSL</span></strong><span> è richiesto ai fini del corretto funzionamento della </span><strong><span>Progressive Web App</span></strong><span> del servizio di </span><strong><span>Notifiche WebPush</span></strong><span> (Vedasi sezione dedicata) e dei possibili </span><strong><span>WebHook</span></strong><span> con servizi esterni.</span></p><p>&nbsp;</p></li></ol><p><img src=".\assets\retefisico.svg" alt="retefisico" style="zoom:70%;" /></p><blockquote><p><span>Consultare paragrafi successivi sull&#39;hardware</span></p></blockquote><h3 id='32---rete-locale'><span>3.2 - Rete Locale </span></h3><p><span>Gli </span><strong><span>attori nella rete locale</span></strong><span> sono i seguenti:</span></p><figure><table><thead><tr><th><span>Nome</span></th><th><span>Ruolo</span></th><th><span>Indirizzo Statico Locale</span></th></tr></thead><tbody><tr><td><span>Router Tim Hub</span></td><td><span>Default Gateway</span></td><td><span>192.168.1.1</span></td></tr><tr><td><span>Raspberry Pi 4</span></td><td><span>Server</span></td><td><span>192.168.1.50</span></td></tr><tr><td><span>Shelly EM</span></td><td><span>Client/Server IoT (Smart Sensor)</span></td><td><span>192.168.1.51</span></td></tr><tr><td><span>Shelly 1</span></td><td><span>Client/Server IoT (Smart Sensor)</span></td><td><span>192.168.1.X*</span></td></tr></tbody></table></figure><blockquote><p><span>NOTE: </span></p><ul><li><p><span>Il </span><strong><span>numero di Dispositivi Shelly 1 nella rete locale è variabile.</span></strong><span> Nella sperimentazione pratica del progetto è presente un solo dispositivo, ma il funzionamento è pensato per N dispositivi Shelly che collaborino contemporaneamente.</span></p><p><span>Inoltre, i dispositivi Shelly possono essere configurati per funzionare in HTTP, MQTT, e CoIoT(CoAP).</span>
<span>(Vedasi paragrafo dedicato)</span></p></li></ul></blockquote><p><span>I </span><strong><span>Port Forwarding</span></strong><span> configurati internamente sono i seguenti:</span></p><figure><table><thead><tr><th><span>Servizio</span></th><th><span>Porta in Entrata</span></th><th><span>Porta di re-indirizzamento</span></th><th><span>Dispositivo Finale</span></th></tr></thead><tbody><tr><td><span>HTTP</span></td><td><span>80</span></td><td><span>80</span></td><td><span>Pi (server)</span></td></tr><tr><td><span>SSH*</span></td><td><span>22</span></td><td><span>22</span></td><td><span>Pi (server)</span></td></tr><tr><td><span>Servizio Web Custom</span></td><td><span>8443</span></td><td><span>8443</span></td><td><span>Pi (server)</span></td></tr></tbody></table></figure><blockquote><p><span>NOTE: </span></p><ul><li><span>La </span><strong><span>porta 80</span></strong><span> è necessaria per il completamento della verifica da parte dell&#39;ente </span><strong><span>Let&#39;s Encrypt</span></strong><span> che certifica la validità del server al fine di assegnare un certificato SSL firmato (Vedasi paragrafo certificato SSL).</span></li><li><span>La </span><strong><span>porta 22</span></strong><span> è utilizzata in </span><strong><span>fase di sviluppo</span></strong><span> per </span><em><span>connessione</span></em><span> e </span><em><span>testing</span></em><span> da remoto via SSH.</span></li></ul></blockquote><h3 id='33---interfacciamento-con-rete-esterna'><span>3.3 - Interfacciamento con Rete Esterna</span></h3><p><span>Essendo il Server </span><strong><span>hostato su macchina locale</span></strong><span> (vedasi schema di rete) è necessaria una configurazione affinchè sia possibile essere raggiungibili dall&#39;esterno.</span></p><h4 id='331---dynamicdns'><span>3.3.1 - DynamicDNS</span></h4><p><span>Per incontrare i requisiti elencati sopra nel progetto si utilizza la tecnologia di </span><strong><span>Dynamic DNS.</span></strong></p><blockquote><p><span>Un </span><strong><span>provider</span></strong><span> </span><strong><span>dynDNS</span></strong><span> permette di registrare un proprio dominio che punti sempre all&#39;indirizzo IP più aggiornato di una rete privata (l&#39;</span><strong><span>indirizzo IP è assegnato dinamicamente dall&#39;ISP</span></strong><span>).</span></p></blockquote><p><span>Per </span><strong><span>mantenere aggiornato il Provider con il proprio indirizzo IP Pubblico</span></strong><span> è necessario uno script che, ad ogni nuovo ottenimento di indirizzo IP, </span><strong><span>comunichi</span></strong><span> </span></p><p><img src="https://camo.githubusercontent.com/1624fb285ef6375dbbc7a67723f96b7d01b7857dc794f133ddab1828b7252d6a/68747470733a2f2f692e6962622e636f2f426638734879782f696d6167652d32303231303530353038333830353438302e706e67" referrerpolicy="no-referrer" alt="image-20210505083805480"></p><blockquote><p><span>Nell&#39;immagine il </span><strong><span>pannello di controllo di NO-IP</span></strong><span>. </span></p></blockquote><p><span>Nei router più moderni </span><em><span>(nel progetto è un Tim Hub)</span></em><span> è possibile </span><strong><span>attivare il servizio di Dynamic DNS automaticamente</span></strong><span>, inserendo le </span><strong><span>credenziali</span></strong><span> del provider a cui si è registrati.</span></p><h4 id='332---certificati'><span>3.3.2 - Certificati</span></h4><p><span>Come espresso nella sezione precedente, un </span><strong><span>certificato SSL</span></strong><span> è richiesto ai fini del corretto funzionamento di:</span></p><ul><li><span>PWA</span></li><li><span>WEBHOOK</span></li></ul><p><span>E in generale per qualsiasi richiesta che richieda HTTPS.</span></p><p><span>Let&#39;s Encrypt è un provider di certificati SSL. Per verificare l&#39;identità del server si appoggia a un </span><strong><span>tool da command line, CERTBOT</span></strong><span>.</span></p><p><img src=".\assets\certbot.png" referrerpolicy="no-referrer" alt="certbot"></p><p><span>Certbot funziona in questo modo:</span></p><ol start='' ><li><span>Si </span><strong><span>installa</span></strong><span> sul server</span></li><li><span>Si seguono le istruzioni da command line</span></li><li><span>Si </span><strong><span>crea un file che soddisfi una challenge</span></strong><span> (challenge è il termine per la verifica di un file)</span></li><li><span>Certbot chiede a Let&#39;s Encrypt di </span><strong><span>eseguire una chiamata sul server per verificare la challenge</span></strong></li><li><span>Se la verifica va a buon fine, Certbot richiede un </span><strong><span>certificato firmato da Let&#39;s Encrypt.</span></strong></li></ol><h2 id='4-componenti-hardware'><span>4. Componenti Hardware</span></h2><p><span>La componentistica impiegata nel progetto è la seguente:</span></p><h3 id='41---server'><span>4.1 - Server</span></h3><p><span>Nel ruolo di Server è presente un Raspberry PI da 4GB, installato nella rete locale.</span>
<span>Di seguito le specifiche tecniche:</span></p><figure><table><thead><tr><th><span>Componente</span></th><th><span>Specifiche</span></th></tr></thead><tbody><tr><td><span>Processore</span></td><td><span>Cortex-A72 (ARM v8) a 64-bit @ 1.5GHz</span></td></tr><tr><td><span>Memoria</span></td><td><span>4GB LPDDR4</span></td></tr><tr><td><span>Connettività</span></td><td><span>Wi-Fi 802.11b/g/n/ac - 2.4 / 5GHz</span><br><span>Bluetooth 5.0 BLE </span><br><span>Gigabit Ethernet </span><br></td></tr><tr><td><span>I/O</span></td><td><span>2 × porte USB 3.0</span><br><span>2 × porte USB 2.0</span></td></tr><tr><td><span>Alimentazione</span></td><td><span>5V DC via USB-C (minimo 3A)</span></td></tr></tbody></table></figure><blockquote><p><span>Ulteriori specifiche hardware del Raspberry PI </span><a href='https://www.raspberrypi.org/products/raspberry-pi-4-model-b/specifications/'><span>qui</span></a><span>	</span></p></blockquote><p><img src="https://www.raspberrypi.org/homepage-9df4b/static/blueprint-0970cf0c1f5446a311a64d0106f9767b.svg" referrerpolicy="no-referrer" alt="Raspberry Pi 4 Model B blueprint"></p><h3 id='42---sensori-smart'><span>4.2 - Sensori Smart</span></h3><p><span>Gli smart sensors impiegati sono dispositivi </span><strong><span>Shelly</span></strong><span>.</span>
<span>La scelta ricade su Dispositivi Shelly in quanto forniti con supporto a </span><strong><span>API REST</span></strong><span> e </span><strong><span>MQTT</span></strong>
<span>In particolare:</span></p><figure><table><thead><tr><th><span>Componente</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>Shelly EM</span></td><td><span>Energy Meter con Pinza Amperometrica, misura a monte il consumo (passivo)</span></td></tr><tr><td><span>Shelly 1</span></td><td><span>Misura e agisce sul passaggio di corrente per un utilizzatore singolo (attivo / passivo)</span></td></tr></tbody></table></figure><h4 id='411---shelly-1'><span>4.1.1 - Shelly 1</span></h4><p><span>Shelly 1 è uno Smart Switch in grado di effettuare </span><strong><span>misurazioni e azioni sui contatti collegati.</span></strong></p><p><span>Il comando per accendere / spegnere può provenire da:</span></p><ul><li><span>Bottone fisico</span></li><li><span>Richiesta </span><strong><span>HTTP</span></strong></li><li><span>Comando </span><strong><span>MQTT</span></strong></li></ul><figure><table><thead><tr><th><span>Proprietà</span></th><th><span>Valore</span></th></tr></thead><tbody><tr><td><span>Dimensioni</span></td><td><span>41x36x17 mm</span></td></tr><tr><td><span>Alimentazione</span></td><td><span>12V DC</span></td></tr><tr><td><span>Carico massimo</span></td><td><span>16A - 3.5 kW</span></td></tr><tr><td><span>Consumo elettrico</span></td><td><span>&lt; 1W</span></td></tr><tr><td><span>Protocollo Radio</span></td><td><span>WiFi 802.11 b/g/n - 2.4GHz</span></td></tr></tbody></table></figure><p><img src="https://lamiacasaelettrica.com/wp-content/uploads/2019/03/shelly-1-top-1024x828.png" alt="Shelly 1 WiFi interruttore con contatto pulito | Schema ed istruzioni" style="zoom:20%;" /></p><p>&nbsp;</p><h4 id='413---shelly-em'><span>4.1.3 - Shelly EM</span></h4><p><span>Shelly EM è un sensore dotato di </span><strong><span>pinza amperometrica.</span></strong></p><p><span>I vantaggi dell&#39;utilizzo di Shelly EM:</span></p><ul><li><span>Non è invasivo, quindi non implica modifiche all’impianto elettrico</span></li><li><span>La corrente del carico controllato non attraversa il dispositivo, evitando così rischio di danni accidentali. Questo è possibile poichè viene utilizzata una </span><strong><span>pinza amperometrica</span></strong><span> per la misurazionez</span></li></ul><blockquote><p><span>La pinza amperometrica in dotazione viene fornita in due taglie : </span><em><span>50A (11KW) e 120A (26KW)</span></em><span>. Si tratta di taglie più che sufficienti in ambito domestico dove la corrente nominale non supera la soglia dei 16A.</span></p></blockquote><p float="left">
	<img src="https://indomus.it/wp-content/uploads/Shelly-EM-con-pinze.jpg" alt="Recensione: Shelly EM | inDomus.it" style="zoom:33%;">
</p><p>&nbsp;</p><figure><table><thead><tr><th><span>Proprietà</span></th><th><span>Valore</span></th></tr></thead><tbody><tr><td><span>Dimensioni</span></td><td><span>41x36x17 mm</span></td></tr><tr><td><span>Alimentazione</span></td><td><span>110-230 V</span></td></tr><tr><td><span>Carico massimo</span></td><td><span>16A - 3.5 kW</span></td></tr><tr><td><span>Consumo elettrico</span></td><td><span>&lt; 1W</span></td></tr><tr><td><span>Protocollo Radio</span></td><td><span>WiFi 802.11 b/g/n - 2.4GHz</span></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></figure><p><span>Tutti i dispositivi espongono un server HTTP locale in ascolto sulla porta 80. </span>
<span>Durante la modalità AP il dispositivo può essere raggiunto all&#39;indirizzo:</span></p><blockquote><p><a href='http://192.168.33.1/' target='_blank' class='url'>http://192.168.33.1/</a></p></blockquote><p><span>L&#39;indirizzo è univoco in quanto presente all&#39;intero della sola rete WiFi creata dal singolo dispositivo.</span>
<span>Al fine del progetto tuttavia non viene utilizzata la modalità AP (access point) ma bensì quella STA (station). Vedasi il paragrafo dedicato.</span></p><h4 id='414---installazione-sensori-nellimpianto-elettrico'><span>4.1.4 - Installazione Sensori nell&#39;impianto elettrico</span></h4><p><span>La </span><strong><span>dimensione contenute</span></strong><span> (consultare le schede precedenti) dei sensori Shelly consentono l&#39;installazione anche in una comune scatola </span><strong><span>503:</span></strong></p><p><img src=".\assets\scatola_vimar.png" style="zoom:33%;" /></p><p>&nbsp;</p><blockquote><p><span>Shelly1 viene installata generalmente dietro alle prese elettriche</span></p></blockquote><p><img src="\assets\shelly_install.png" alt="shelly_install" style="zoom:33%;" /></p><figure><table><thead><tr><th><span>Entrata</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>O e I</span></td><td><span>Uscite di comando carico elettrico (contatto pulito)</span></td></tr><tr><td><span>SW</span></td><td><span>Ingresso per comando esterno</span></td></tr><tr><td><span>L</span></td><td><span>Ingresso alimentazione di rete (</span><strong><span>fase</span></strong><span>)</span></td></tr><tr><td><span>N</span></td><td><span>Intresso alimentazion di rete (</span><strong><span>neutro</span></strong><span>)</span></td></tr></tbody></table></figure><p><span>Installazione nell&#39;impianto elettrico di Shelly EM:</span></p><p><img src=".\assets\shelly_em.jpg" alt="shelly_em" style="zoom:50%;" /></p><figure><table><thead><tr><th><span>Entrata</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>P1+ / P1-</span></td><td><span>Ingressi +/- per trasformatore di corrente</span></td></tr><tr><td><span>P2+ / P2-</span></td><td><span>Ingressi +/- per trasformatore di corrente 2</span></td></tr><tr><td><span>L</span></td><td><span>Ingresso alimentazione di rete (</span><strong><span>fase</span></strong><span>)</span></td></tr><tr><td><span>N</span></td><td><span>Intresso alimentazion di rete (</span><strong><span>neutro</span></strong><span>)</span></td></tr><tr><td><span>O</span></td><td><span>Uscita per comando </span><strong><span>contattore</span></strong><span> </span><strong><span>esterno</span></strong></td></tr></tbody></table></figure><p><span>Di seguito illustrata l&#39;installazione delle pinze amperometriche:</span></p><p><span>Per l’</span><strong><span>installazione</span></strong><span> dei </span><strong><span>sensori a clip</span></strong><span>:</span></p><ul><li><span>Individuare </span><strong><span>cavo di fase</span></strong><span> nella scatola di derivazione principale.</span></li><li><span>aprire il sensore facendo leva sulla linguetta di chiusura</span></li><li><span>Posizionare il sensore a clip intorno al </span><strong><span>solo cavo di fase</span></strong></li><li><span>Chiudere il Sensore</span></li></ul><p><img src=".\assets\installazioneshellyem.png" alt="installazioneshellyem" style="zoom:33%;" /></p><p>&nbsp;</p><h2 id='5-componenti-software'><span>5. Componenti Software</span></h2><p><img src=".\assets\blocchistruttura.svg" referrerpolicy="no-referrer" alt="blocchistruttura"></p><figure><table><thead><tr><th><span>Componente</span></th><th><span>Descrizione Componente</span></th></tr></thead><tbody><tr><td><span>HA Core</span></td><td><span>Sistema di gestione IoT e messaggio CoAP</span></td></tr><tr><td><span>PWA Amministrazione</span></td><td><span>Sistema di amministrazione Server</span></td></tr><tr><td><span>Proxy Controller</span></td><td><span>Gestione delle richieste (forward e reverse proxy)</span></td></tr></tbody></table></figure><p><img src=".\assets\stack-tech.svg" style="zoom:67%;" /></p><p><span>Di seguito l&#39;insieme delle Tecnologie impiegate</span></p><figure><table><thead><tr><th><span>Componente</span></th><th><span>Tecnologia</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><strong><span>HA Core</span></strong></td><td><span>Python</span></td><td><span>Runtime</span></td></tr><tr><td>&nbsp;</td><td><span>Django</span></td><td><span>Framework Web Embedded</span></td></tr><tr><td>&nbsp;</td><td><span>Jinja2</span></td><td><span>Template Engine Embedded</span></td></tr><tr><td><strong><span>PWA Amministrazione</span></strong></td><td><span>Node.js</span></td><td><span>Runtime</span></td></tr><tr><td>&nbsp;</td><td><span>Express.js</span></td><td><span>Framework Web</span></td></tr><tr><td>&nbsp;</td><td><span>EJS</span></td><td><span>Template Engine</span></td></tr><tr><td><strong><span>Proxy</span></strong></td><td><span>Node.js</span></td><td><span>Runtime</span></td></tr><tr><td>&nbsp;</td><td><span>JWT</span></td><td><span>Gestione Sicurezza</span></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></figure><p>&nbsp;</p><p><span>Il Pattern Architetturale del Progetto è quello </span><strong><span>MVC</span></strong><span> (Model-View-Controller).</span></p><p><span>Di seguito è elencata la struttura del progetto. </span></p><figure><table><thead><tr><th><span>Struttura App Node.js</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>├── 📂 Bin</span></td><td><span>Configurazione Server e Entry Point</span></td></tr><tr><td><span>├── 📂 Controllers</span></td><td><span>Business Logic</span></td></tr><tr><td><span>├── 📂 Private</span></td><td><span>Chiavi private / pubbliche / certificati / Database</span></td></tr><tr><td><span>├── 📂 Public</span></td><td><span>File serviti</span></td></tr><tr><td><span>├── 📂 Routes</span></td><td><span>Rotte di Express</span></td></tr><tr><td><span>├── 📂 Utils</span></td><td><span>Classi di supporto</span></td></tr><tr><td><span>├── 📂 Views</span></td><td><span>Viste renderizzate da EJS</span></td></tr><tr><td><span>├── app.js</span></td><td><span>Riferimento Router Express</span></td></tr></tbody></table></figure><figure><table><thead><tr><th><span>Struttura Cartella Configurazione HA-Core</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>├── ⚙ automations.yaml</span></td><td><span>Configurazione automazioni</span></td></tr><tr><td><span>├── ⚙ scenes.yaml</span></td><td><span>Configurazione scene (non impiegato)</span></td></tr><tr><td><span>├── ⚙ custom-css.css</span></td><td><span>Personalizzazione CSS</span></td></tr><tr><td><span>├── ⚙ home-assistant.log</span></td><td><span>Log di sistema</span></td></tr><tr><td><span>├── ⭐configuration.yaml</span></td><td><span>File di configurazione globale principale</span></td></tr><tr><td><span>├── ⚙ home-assistant_v2.db</span></td><td><span>DB Sqlite Interno</span></td></tr></tbody></table></figure><h3 id='51---database'><span>5.1 - Database</span></h3><p><span>Il Database impiegato è </span><strong><span>Sqlite</span></strong><span>.</span></p><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/SQLite370.svg/1200px-SQLite370.svg.png" style="zoom: 15%;" /></p><blockquote><p><span>Sqlite è un Database </span><strong><span>relazionale</span></strong><span> </span><em><span>multi-platform</span></em><span>, open-source di dominio pubblico, e </span><em><span>ultra-leggero.</span></em>
<span>Non dispone di un Engine che lavori su thread separato e </span><strong><span>scrive direttamente in memoria su File.</span></strong></p></blockquote><p><span>Impiegando un </span><strong><span>Raspberry PI</span></strong><span> con </span><strong><span>Raspbian</span></strong><span> nel ruolo di </span><strong><span>macchina</span></strong><span> </span><strong><span>Server locale</span></strong><span> (Vedasi sezione riferita all&#39;Hardware impiegato), non è necessario l&#39;utilizzo di un Database Enterprise come </span><em><span>SQLServer</span></em><span> ( quest&#39;ultimo nemmeno disponibile su piattaforma Linux) o come </span><em><span>MySQL</span></em><span> (risorse superflue per il progetto).</span></p><p><span>Tale scelta può variare a seconda del Poll-Rate deciso (frequenza di </span><strong><span>operazioni R/W</span></strong><span>) e dalla necessità di:</span></p><ul><li><span>Meccanismi che richiedono </span><strong><span>monitoraggio dei dati su thread separato</span></strong><span> come i </span><strong><span>Trigger</span></strong></li><li><strong><span>Accessi Multipli</span></strong><span> al Database</span></li><li><strong><span>DataType</span></strong><span> complessi</span></li><li><strong><span>Scalabilità</span></strong><span> su moli di dati nell&#39;ordine dei TB di memoria fissa e dei GB di RAM</span></li></ul><p><span>Ulteriori informazioni e casi d&#39;uso nella </span><a href='https://www.sqlite.org/whentouse.html'><span>documentazione ufficiale di Sqlite</span></a><span>)</span></p><h4 id='511---struttura-base-di-dati'><span>5.1.1 - Struttura Base di Dati</span></h4><p><span>La struttura della base di dati è la seguente:</span></p><p><img src=".\assets\db.svg" referrerpolicy="no-referrer" alt="ParsedScriptLayout"></p><figure><table><thead><tr><th><span>Entità</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>Eventi</span></td><td><span>Aggiornamenti circa gli eventi verificati e intercettati</span></td></tr><tr><td><span>Misurazioni</span></td><td><span>Aggiornamenti circa le misurazioni ottenute</span></td></tr><tr><td><span>Sensori</span></td><td><span>Informazioni circa le entità sensori registrate nella rete</span></td></tr><tr><td><span>Utenti</span></td><td><span>Informazioni degli utenti autorizzati ad accedere</span></td></tr><tr><td><span>Clients</span></td><td><span>Informazioni circa i client registrati al servizio di Push Notification della PWA</span></td></tr></tbody></table></figure><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EVENTI(id_evento(PK),trigger,timestamp,payload,id_evento_precedente(rFK))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">MISURAZIONI(id_misurazione(PK),id_sensore(FK),timestamp,valore,id_misurazione_precedente(rFK))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENSORI(id_sensore(PK),alias_sensore,indirizzo_ip,status)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">UTENTI(id_utente(PK),nome_utente,hashpassword,is_admin(0,1))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLIENTS(id_client(PK),id_utente(FK),url_endpoint_push_notification)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 156px;"></div><div class="CodeMirror-gutters" style="height: 156px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><blockquote><p><span>PK = Primary Key</span>
<span>FK = Foreign Key</span>
<span>rFK = Recursive Foreign Key</span></p></blockquote><p><strong><span>N.b.</span></strong><span> Questa tipologia di integrazioni causa un enorme </span><strong><span>afflusso di dati</span></strong><span> verso </span><strong><span>l&#39;endpoint</span></strong><span> della domotica: per evitare che i dati vengano scritti su database (causando perdita di performance e anche possibili rotture dello storage in particolare laddove si utilizzi una </span><strong><span>microSD</span></strong><span> per l’esecuzione , è necessario effettuare </span><strong><span>opportuni filtraggi sui dati in entrata.</span></strong></p><p>&nbsp;</p><h4 id='512---query-rilevanti'><span>5.1.2 - Query Rilevanti</span></h4><p><span>Esempi di query sono:</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sqlite" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="sqlite"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--2. Classifica dei consumi dei dispositivi</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> alias_sensore <span class="cm-keyword">AS</span> Dispositivo<span class="cm-punctuation">,</span> SUM<span class="cm-bracket">(</span>consumi<span class="cm-bracket">)</span> <span class="cm-keyword">AS</span> <span class="cm-bracket">[</span>Totale Consumi<span class="cm-bracket">]</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">FROM</span> MISURAZIONI </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">INNER <span class="cm-keyword">JOIN</span> SENSORI <span class="cm-keyword">ON</span> SENSORI<span class="cm-variable-2">.id_sensore</span> <span class="cm-operator">=</span> MISURAZIONI<span class="cm-variable-2">.id_sensore</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ORDER</span> <span class="cm-keyword">BY</span> Dispositivo <span class="cm-keyword">DESC</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--3. Consumi dell'ultimo mese di un dispositivo</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> alias_sensore <span class="cm-keyword">AS</span> Dispositivo<span class="cm-punctuation">,</span> SUM<span class="cm-bracket">(</span>consumi<span class="cm-bracket">)</span> <span class="cm-keyword">AS</span> <span class="cm-bracket">[</span>Consumo Mensile<span class="cm-bracket">]</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">FROM</span> MISURAZIONI</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">INNER <span class="cm-keyword">JOIN</span> SENSORI <span class="cm-keyword">ON</span> SENSORI<span class="cm-variable-2">.id_sensore</span> <span class="cm-operator">=</span> MISURAZIONI<span class="cm-variable-2">.id_sensore</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ORDER</span> <span class="cm-keyword">BY</span> Dispositivo <span class="cm-keyword">DESC</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--5. Media dei consumi generali in fascia F1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> AVG<span class="cm-bracket">(</span>valore<span class="cm-bracket">)</span> <span class="cm-keyword">AS</span> <span class="cm-bracket">[</span>Media consumi F1<span class="cm-bracket">]</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">FROM</span> MISURAZIONI </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">INNER <span class="cm-keyword">JOIN</span> SENSORI <span class="cm-keyword">ON</span> misurazioni<span class="cm-variable-2">.id_sensore</span> <span class="cm-operator">=</span> sensori<span class="cm-variable-2">.id_sensore</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">WHERE</span> <span class="cm-bracket">(</span><span class="cm-builtin">timestamp</span> <span class="cm-operator">&gt;</span> @F1<span class="cm-variable-2">.START</span> <span class="cm-keyword">AND</span> <span class="cm-builtin">timestamp</span> <span class="cm-operator">&lt;</span> @F1<span class="cm-variable-2">.END</span><span class="cm-bracket">)</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">AND</span> <span class="cm-bracket">(</span>id_sensore <span class="cm-operator">=</span> @shellyEM<span class="cm-variable-2">.id</span><span class="cm-bracket">)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--6. Elenco dei dispositivi e degli endpoint push notifiction per un utente</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> id_client<span class="cm-punctuation">,</span>url_endpoint_notification</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">WHERE</span> clients<span class="cm-variable-2">.id_utente</span> <span class="cm-operator">=</span> @id_client</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 598px;"></div><div class="CodeMirror-gutters" style="height: 598px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><h4 id='513---accesso-al-db'><span>5.1.3 - Accesso al DB</span></h4><p><span>L&#39;API di accesso al DB è basata sulla libreria SQLITE3 i cui binari devono essere installati sulla macchina server. </span></p><blockquote><p><span>NOTA : La libreria ufficiale di SQLITE3 per Node.js non supporta le </span><em><span>async / await</span></em><span> poichè rimasta allo stile di programmazione </span><em><span>callback-style</span></em><span> tipico di Node. </span>
<span>Nel progetto è stata quindi creata una classe che incapsula callback all&#39;interno di promise così da supportare async / await.</span></p></blockquote><h3 id='52---shelly--iot-logic'><span>5.2 - Shelly &amp; IoT Logic</span></h3><p><span>La Gestione dell&#39;IoT nella rete locale avviene attraverso protocollo </span><strong><span>CoIoT (CoAP-based)</span></strong></p><p><img src=".\assets\rete-locale.svg" referrerpolicy="no-referrer" alt="rete-locale"></p><blockquote><p><strong><span>CoAP è una versione di HTTP ottimizzata per l&#39;IoT</span></strong><span> e altri campi applicativi ove è necessario avere pacchetti molto leggeri. </span>
<span>Le differenze principali sono rappresentate da:</span></p><ul><li><span>Impiego dell&#39;</span><strong><span>UDP anzichè TCP</span></strong></li><li><strong><span>Dimensione dell&#39;Header</span></strong><span> ridotta a 4byte</span></li></ul></blockquote><p><span>Per le specifiche sul protocollo CoAP (CoIoT) impiegato dai dispositivi Shelly si consulti </span><a href='https://shelly-api-docs.shelly.cloud/#coiot-device-status-cit-s'><span>la documentazione ufficiale</span></a></p><h4 id='521---configurazione-http'><span>5.2.1 - Configurazione HTTP</span></h4><p><span>E&#39;necessario configurare manualmente i Sensori Shelly con chiamate HTTP per attivare CoAP</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>19</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Gestione </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">POST</span> <span class="cm-operator">/</span><span class="cm-variable">settings</span><span class="cm-operator">/</span><span class="cm-variable">cloud</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">?</span><span class="cm-variable">enabled</span><span class="cm-operator">=</span><span class="cm-number">0</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">POST</span> <span class="cm-operator">/</span><span class="cm-variable">settings</span><span class="cm-operator">/</span><span class="cm-variable">ap</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">?</span><span class="cm-variable">enabled</span><span class="cm-operator">=</span><span class="cm-number">0</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Abilitazione dell'STA mode</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">POST</span> <span class="cm-operator">/</span><span class="cm-variable">settings</span><span class="cm-operator">/</span><span class="cm-variable">sta</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">?</span><span class="cm-variable">enabled</span><span class="cm-operator">=</span><span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&amp;</span><span class="cm-variable">ssid</span><span class="cm-operator">=</span><span class="cm-variable">NOME_RETE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&amp;</span><span class="cm-variable">password</span><span class="cm-operator">=</span><span class="cm-variable">PASSWORD</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Abilitazione dei CoAP / CoIoT</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">POST</span> <span class="cm-operator">/</span><span class="cm-variable">settings</span><span class="cm-operator">/</span><span class="cm-variable">coiot</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">?</span><span class="cm-variable">enabled</span><span class="cm-operator">=</span><span class="cm-number">1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&amp;</span><span class="cm-variable">peer_endpoint</span><span class="cm-operator">=</span><span class="cm-variable">MIO_IP</span>:<span class="cm-variable">PORTA</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 494px;"></div><div class="CodeMirror-gutters" style="height: 494px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><figure><table><thead><tr><th><span>Chiamata</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>/settings/cloud</span></td><td><span>Regola l&#39;accesso al cloud proprietario di Shelly</span></td></tr><tr><td><span>/settings/sta</span></td><td><span>Regola l&#39;utilizzo della modalità Station per connettersi alla Rete</span></td></tr><tr><td><span>/settings/ap</span></td><td><span>Regola l&#39;utilizzo della modalità Access Point</span></td></tr><tr><td><span>/settings/coiot</span></td><td><span>Regolazione utilizzo CoIoT e inserimento peer di riferimento</span></td></tr></tbody></table></figure><p><span>L&#39;alternativa è quella di configurare un messaggio HTTP personalizzato al superamento di una soglia precedentemente impostata</span><strong><span>(HTTP, non CoAP)</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="http"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="http"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">POST</span> <span class="cm-string-2">/api/services/script/turn_on</span> <span class="cm-keyword">HTTP/1.1</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Host:</span><span class="cm-string"> MIO_</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Authorization:</span><span class="cm-string"> Bearer !MIO_TOKEN</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">Content-Type:</span><span class="cm-string"> text/plain</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "entity_id":"script.avverti_superamento_corrente",</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  "valore_corrente":"XXX"</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 234px;"></div><div class="CodeMirror-gutters" style="height: 234px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>Questo messaggio viene recapitato direttamente al server di gestione.</span></p><h4 id='522-ricezione-shelly'><span>5.2.2 Ricezione Shelly</span></h4><p><span>Si è predisposto un layer Proxy interno al server di gestione Python affinchè sia possibile gestire l&#39;IoT in una rete virtuale interna (VLAN). </span><strong><span>(Vedasi sezione in fondo riguardo gli aggiornamenti da eseguirsi)</span></strong></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8335px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>29</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Script interno Python che riceve i messaggi CoAP e inoltra all'endpoint di Gestione dell'IoT interno</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">HA_IP</span> = <span class="cm-string">"192.168.1.50"</span> <span class="cm-comment">#IP di HA</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">PORTA_UDP</span> = <span class="cm-number">5683</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Impostazione socket UDP</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sock</span> = <span class="cm-variable">socket</span>.<span class="cm-property">socket</span>(<span class="cm-variable">socket</span>.<span class="cm-property">AF_INET</span>, <span class="cm-variable">socket</span>.<span class="cm-property">SOCK_DGRAM</span>, <span class="cm-variable">socket</span>.<span class="cm-property">IPPROTO_UDP</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sock</span>.<span class="cm-property">setsockopt</span>(<span class="cm-variable">socket</span>.<span class="cm-property">SOL_SOCKET</span>, <span class="cm-variable">socket</span>.<span class="cm-property">SO_REUSEADDR</span>, <span class="cm-number">1</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sock</span>.<span class="cm-property">bind</span>((<span class="cm-string">''</span>, <span class="cm-variable">PORTA_UDP</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mreq</span> = <span class="cm-variable">struct</span>.<span class="cm-property">pack</span>(<span class="cm-string">"4sl"</span>, <span class="cm-variable">socket</span>.<span class="cm-property">inet_aton</span>(<span class="cm-variable">UDP_IP</span>), <span class="cm-variable">socket</span>.<span class="cm-property">INADDR_ANY</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sock</span>.<span class="cm-property">setsockopt</span>(<span class="cm-variable">socket</span>.<span class="cm-property">IPPROTO_IP</span>, <span class="cm-variable">socket</span>.<span class="cm-property">IP_ADD_MEMBERSHIP</span>, <span class="cm-variable">mreq</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span> <span class="cm-keyword">True</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword cm-error">try</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">#Ricezione messaggi CoAP</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">data</span>, <span class="cm-variable">addr</span> = <span class="cm-variable">sock</span>.<span class="cm-property">recvfrom</span>(<span class="cm-number">10240</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">s</span> = <span class="cm-string">"Ricevuto: %s"</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span>(<span class="cm-variable">s</span> <span class="cm-operator">%</span> (<span class="cm-variable">addr</span>[<span class="cm-number">0</span>], <span class="cm-variable">addr</span>[<span class="cm-number">1</span>], <span class="cm-variable">dati</span>.<span class="cm-property">decode</span>(<span class="cm-string">"ascii"</span>)))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">#Aggiunta dell'IP al messaggio (funzione proxy)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">newdata</span> = <span class="cm-builtin">bytearray</span>(<span class="cm-string">b'prxy'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">newdata</span>.<span class="cm-property">extend</span>(<span class="cm-variable">socket</span>.<span class="cm-property">inet_aton</span>(<span class="cm-variable">addr</span>[<span class="cm-number">0</span>]))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">newdata</span>.<span class="cm-property">extend</span>(<span class="cm-variable">data</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">#Invia all'endpoint che gestisce IoT</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sock</span>.<span class="cm-property">sendto</span>(<span class="cm-variable">newdata</span>, (<span class="cm-variable">HA_IP</span>, <span class="cm-variable">UDP_PORT</span>))</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword cm-error">except</span> <span class="cm-variable">Exception</span> <span class="cm-keyword">as</span> <span class="cm-variable">e</span>:</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span> (<span class="cm-string">'exception '</span> <span class="cm-operator">+</span> <span class="cm-builtin">str</span>(<span class="cm-variable">e</span>))</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 780px;"></div><div class="CodeMirror-gutters" style="height: 780px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><p><span>Il codice qui sopra si antepone ad ogni richiesta CoAP affinchè i dispositivi possano comunicare con il server pur non rientrando nella stessa rete.</span></p><h3 id='53---ha-core'><span>5.3 - HA-Core</span></h3><p><span>HomeAssistant Core è un applicativo </span><strong><span>Python</span></strong><span> </span><strong><span>stand-alone</span></strong><span> che fornisce una serie di interfacce e integrazioni per la domotica . </span>
<span>La sua funzione nel progetto è quella di astrarre parte della logica di integrazione con alcuni </span><strong><span>dispositivi proprietari</span></strong><span> (ad esempio Alexa).</span></p><h4 id='531---anatomia-dellambiente-di-sviluppo-ha'><span>5.3.1 - Anatomia dell&#39;ambiente di sviluppo HA</span></h4><p><img src="https://developers.home-assistant.io/img/en/architecture/ha_architecture.svg" referrerpolicy="no-referrer" alt="Overview of the Home Assistant core architecture"></p><p>&nbsp;</p><h4 id='532---configurazione-ambiente-di-sviluppo'><span>5.3.2 - Configurazione ambiente di sviluppo</span></h4><p><span>Home Assistant espone 4 principali distribuzioni.</span>
<span>All&#39;interno del progetto si è scelto di utilizzare la </span><strong><span>versione minimale dedicata agli sviluppatori</span></strong><span>. </span><a href='https://www.home-assistant.io/installation/'><span>Vedasi la documentazione ufficiale per visionare le altre opzioni di installazione</span></a></p><p><span>L&#39;installazione minimale può essere eseguita in due modi:</span></p><ul><li><strong><span>Container</span></strong><span> </span><strong><span>Docker </span></strong></li><li><strong><span>Ambiente Virtuale Python</span></strong></li></ul><blockquote><p><strong><span>Si ricorda che la piattaforma di riferimento è Linux con distribuzione Raspbian (Debian-based)</span></strong><span>. La seguente configurazione potrebbe quindi variare.</span></p></blockquote><p><span>Nel presente progetto si è scelto di effettuare l&#39;installazione in Ambiente Virtuale Python </span><strong><span>(venv)</span></strong><span>.</span>
<span>Di seguito l&#39;elenco delle dipendenze da installare via riga di comando:</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Dipendenze richieste</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> apt-get install <span class="cm-attribute">-y</span> python3 python3-dev python3-venv python3-pip libffi-dev libssl-dev libjpeg-dev zlib1g-dev autoconf build-essential libopenjp2-7 libtiff5</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 78px;"></div><div class="CodeMirror-gutters" style="height: 78px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>Si sceglie di creare un </span><strong><span>utente ad hoc</span></strong><span> con permessi limitati: (non obbligatorio ma di riferimento nei passaggi successivi)</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Creazione utente</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> useradd <span class="cm-attribute">-rm</span> homeassistant <span class="cm-attribute">-G</span> dialout,gpio,i2c</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 52px;"></div><div class="CodeMirror-gutters" style="height: 52px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>Come citato sopra si procede con la creazione un ambiente virtuale Python (al momento la versione più aggiornata di Python è la 3.8)</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Predisposizione ambiente virtuale</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> <span class="cm-builtin">mkdir</span> /srv/homeassistant</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> <span class="cm-builtin">chown</span> homeassistant:homeassistant /srv/homeassistant</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> <span class="cm-attribute">-u</span> homeassistant <span class="cm-attribute">-H</span> <span class="cm-attribute">-s</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> /srv/homeassistant</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Creazione ambiente virtuale</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">python3.8 <span class="cm-attribute">-m</span> venv . </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">source</span> bin/activate</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Installazione Package Python</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">python3 <span class="cm-attribute">-m</span> pip install wheel</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 312px;"></div><div class="CodeMirror-gutters" style="height: 312px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Installazione HA-Core</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">pip3 install homeassistant</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Inizializzazione</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&gt; hass</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="height: 130px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p><span>Terminato il processo sono disponibili:</span></p><ul><li><span>Una cartella </span><code>.homeassistant</code><span> contenente i file di configurazione di Home Assistant al percorso</span><code>/home/homeassistant</code></li><li><span>Una interfaccia web in ascolto sulla porta </span><strong><span>8123</span></strong><span> in </span><strong><span>http</span></strong></li></ul><h4 id='533-interfaccia-programmazione-ha'><span>5.3.3 Interfaccia Programmazione HA</span></h4><blockquote><p><strong><span>In HA Ogni elemento può essere creato e modificato con YAML</span></strong></p></blockquote><p><span>HA-Core è basato su concetti di:</span></p><ul><li><span>Automazione</span></li><li><span>Entità</span></li><li><span>Eventi</span></li><li><span>Scene (non impiegate in questo caso)</span></li></ul><p><span>Una automazione è formata essenzialmente da:</span></p><figure><table><thead><tr><th><span>Elemento</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>Trigger</span></td><td><span>Insieme di entità che possono scatenare un evento</span></td></tr><tr><td><span>Condition</span></td><td><span>Insieme di condizioni che vanno verificate</span></td></tr><tr><td><span>Action</span></td><td><span>Insieme di azioni che possono essere eseguite</span></td></tr></tbody></table></figure><h4 id='534-automazione-interruzione--integrazione-con-alexa'><span>5.3.4 Automazione Interruzione &amp; Integrazione con Alexa</span></h4><p><span>L&#39;integrazione con Alexa richiede:</span></p><blockquote><p><span>L&#39;utilizzo del plugin risolve una serie di problemi legati alla realizzazione da zero di una skill di Alexa</span></p></blockquote><ul><li><span>Integrazione come Dispositivo Alexa come Media Player (tramite plugin HA-Core)</span></li><li><span>Attivazione servizio Notify</span></li></ul><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Clonazione repo di alexa_media_player</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> clone <span class="cm-attribute">--branch</span> master https://github.com/custom-components/alexa_media_player</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Spostamento repo di alexa_media_player</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mv</span> ~/config/alexa_media_player/custom_components/alexa_media/ ~/config/custom_components/</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="height: 130px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><blockquote><p><span>Viene omessa la parte di configurazione del componente, è possibile trovarla in internet</span></p></blockquote><p><img src=".\assets\rete-locale.svg" referrerpolicy="no-referrer" alt="rete-locale"></p><p>&nbsp;</p><p><span>Di seguito uno degli script .yaml impiegati per creare una</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>29</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">alias</span><span class="cm-meta">: </span>Trigger potenza critica</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">description</span><span class="cm-meta">: </span><span class="cm-string">''</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">mode</span><span class="cm-meta">: </span>single</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">variables</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  max_val = <span class="cm-string">''</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">trigger</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span><span class="cm-atom">platform</span><span class="cm-meta">: </span>state</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  entity_id</span><span class="cm-meta">: </span>sensor.shelly_EM_current_consumption</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  from</span><span class="cm-meta">: </span><span class="cm-string">'3000'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">condition</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">- </span><span class="cm-atom">condition</span><span class="cm-meta">: </span>template</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  value_template</span><span class="cm-meta">: &gt;</span>-</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">{</span>% for i in group.shelly %<span class="cm-meta">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">{</span>% if group.shelly<span class="cm-meta">[</span>i<span class="cm-meta">]</span>.current_consumption &gt; MAX ) %<span class="cm-meta">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">{</span>% MAX = group.shelly<span class="cm-meta">[</span>i<span class="cm-meta">]</span> %<span class="cm-meta">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">{</span>% endif %<span class="cm-meta">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">{</span>%- endfor %<span class="cm-meta">}</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span><span class="cm-atom">type</span><span class="cm-meta">: </span>is_value</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  condition</span><span class="cm-meta">: </span>device</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  device_id</span><span class="cm-meta">: </span>14b20af8d48682250e8a0029ad12b8c7</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  entity_id</span><span class="cm-meta">: </span>sensor.shelly_shsw_21_5a4834_current_consumption</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  domain</span><span class="cm-meta">: </span>sensor</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">action</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">- </span><span class="cm-atom">service</span><span class="cm-meta">: </span>script.alexa.media_player_notify</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  value_template</span><span class="cm-meta">: {{</span>max_val<span class="cm-meta">}}</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span><span class="cm-atom">service</span><span class="cm-meta">: </span>script.turn_off</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  delay</span><span class="cm-meta">: </span>00<span class="cm-meta">:</span>05<span class="cm-meta">:</span><span class="cm-number">00</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  value_template</span><span class="cm-meta">: {{</span>max_val<span class="cm-meta">}}</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 754px;"></div><div class="CodeMirror-gutters" style="height: 754px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><figure><table><thead><tr><th><span>Costrutto</span></th><th><span>Descrizione</span></th></tr></thead><tbody><tr><td><span>Trigger</span></td><td><span>Entità shelly EM raggiunge un valore consumo superiore a 3000</span></td></tr><tr><td><span>{%%}</span></td><td><span>Sintassi del template engine di Jinja2</span></td></tr><tr><td><span>Ciclo {%for%}</span></td><td><span>Controllo nella collezione di Sensori Shelly (triggera una query sul DB) quale consuma di più</span></td></tr><tr><td><span>Delay</span></td><td><span>Tempo di attesa prima di eseguire l&#39;azione</span></td></tr></tbody></table></figure><p><img src=".\assets\flow_monitor_azione.svg" referrerpolicy="no-referrer" alt="flow_monitor_azione"></p><h4 id='535---monitoraggio-dashboard'><span>5.3.5 - Monitoraggio Dashboard</span></h4><p><img src=".\assets\dashboard.png" referrerpolicy="no-referrer" alt="dashboard"></p><p><span>La UI di Lovelace permette la costruzione semplificata di Dashboard basandosi sulle entità registrate in HA-Core. </span>
<span>Al momento della stesura della relazione sono implementate:</span></p><ul><li><strong><span>Media Consumi Giornalieri</span></strong><span> degli ultimi 30gg</span></li><li><span>Totale Consumi in una Fascia F1 / F2 / F3</span></li><li><span>Consumo Totale Attuale dell&#39;impianto</span></li><li><strong><span>Consumo Attuale</span></strong><span> delle singole entità</span></li><li><span>Segnalazione della </span><strong><span>fascia di consumo</span></strong><span> attuale,</span></li></ul><p><span>La Dashboard è responsive e può anche essere visualizzata da smartphone / dispositivi con display a rapporto diverso da quello di un pc desktop.</span></p><h3 id='54---pwa-admin'><span>5.4 - PWA Admin </span></h3><p>&nbsp;</p><p><img src="https://uploads-ssl.webflow.com/5ccaeaeeb7202a60482bfff7/5e9577a8e9ca8a1ff5d26d05_5_0r9vPH9Ko_v7fU1qawka6W-ueKJCvXtmw_IBr5xLbI6Mn4vQFgSURUCmsRtOn1c3poMEZiQ8MCQecMLO7raV_aRxRm1lCMGCRtAeeGGsq0iusqj__MUB5afgcMNbw95WTToTUg.png" style="zoom: 33%;" /></p><p><span>L&#39;utilizzo di una Progressive Web App è possibile grazie alle funzionalità oggi disponibili tramite </span><strong><span>API dei Browser, sia Mobile che Desktop.</span></strong>
<span>In particolare:</span></p><ul><li><strong><span>Installazione</span></strong><span> di una Web-App</span></li><li><strong><span>Utilizzo</span></strong><span> </span><strong><span>Offline</span></strong><span> di una Web-App</span></li><li><strong><span>Sincronizzazione</span></strong><span> </span><strong><span>in</span></strong><span> </span><strong><span>Background</span></strong><span> con un Server Web</span></li></ul><p><img src=".\assets\installa_app.png" referrerpolicy="no-referrer" alt="installa_app"></p><blockquote><p><span>L&#39;installazione è possibile semplicemente con un service-worker e un webmanifest. Si controlli dalla console di </span><strong><span>DevTools</span></strong><span> per verificare che siano correttamente rilevati entrambi.</span></p></blockquote><p><span>Con i seguenti paragrafi si esplicitano le funzioni sviluppate nella PWA di Amministrazione.</span></p><h4 id='541---web-push'><span>5.4.1 - Web-Push</span></h4><p><span>La tecnologia Web-Push consente la </span><strong><span>ricezione di notifiche</span></strong><span> da parte di un Server Web.</span>
<span>La particolarità sta nel </span><strong><span>ruolo passivo del client</span></strong><span>, che può così </span><strong><span>evitare di eseguire il Polling</span></strong><span> sul Server Web.</span>
<span>Affinchè funzioni è necessario l&#39;intervento di:</span></p><ul><li><strong><span>Service worker</span></strong><span> (Lato Client, esposto in /public dal server)</span></li><li><strong><span>File Javascript con accesso al DOM</span></strong><span> che faccia accesso al Service Worker</span></li><li><strong><span>API del Browser</span></strong><span> </span><a href='https://developer.mozilla.org/en-US/docs/Web/API/Push_API?retiredLocale=it'><span>che supportino WebPush</span></a><span> </span></li><li><span>Browser con </span><strong><span>Server WebPush</span></strong></li></ul><h4 id='542---flusso-del-webpush'><span>5.4.2 - Flusso del WebPush</span></h4><p><img src="https://3.bp.blogspot.com/-4vzsc4O6rbI/Wj7oW2q4vOI/AAAAAAAAAxw/mqT5iWGQ2yIujBzRZEq_AfjHG0uF6xdlACLcBGAs/s1600/Web%2BPush%2BProtocol%2BFlow.png" referrerpolicy="no-referrer" alt="Push Notifications and ASP.NET Core - Part 1 (Push API)"></p><ol start='' ><li><p><span>Utente (serviceWorker) si </span><strong><span>iscrive</span></strong><span> al Servizio di Push (grant permission)</span></p></li><li><p><span>Lo User-Agent (Browser) richiede al proprio </span><strong><span>Push Message Provider</span></strong><span> :</span></p><ul><li><strong><span>Public Key</span></strong><span> del Server</span></li><li><span>URL dell&#39;Endpoint (</span><strong><span>Push Service</span></strong><span>) </span>
<span>L&#39;URL è univoco per ogni utente</span></li></ul></li><li><p><span>L&#39;utente </span><strong><span>invia al Server</span></strong><span> i dati ricevuti e li incapsula in un oggetto &quot;</span><strong><span>subscription</span></strong><span>&quot;</span></p></li></ol><p><span>Di seguito viene illustrato il codice client e server che permette l&#39;impiego dell&#39;API di WebPush.</span></p><p><span>Omettendo la gestione degli eventi da parte del backgroundworker, si possono distinguere le azioni precedentemente elencate:</span></p><ol start='' ><li><span>Ottenimento degli o</span></li></ol><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Oggetto iscrizione - Client side</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">const</span> <span class="cm-def">iscrizione</span> <span class="cm-operator">=</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-property">endpoint</span>: <span class="cm-variable">pushSubscription</span>.<span class="cm-property">endpoint</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-property">keys</span>: {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">p256dh</span>: <span class="cm-variable">pushSubscription</span>.<span class="cm-property">getKeys</span>(<span class="cm-string">'p256dh'</span>),</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">auth</span>: <span class="cm-variable">pushSubscription</span>.<span class="cm-property">getKeys</span>(<span class="cm-string">'auth'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 208px;"></div><div class="CodeMirror-gutters" style="height: 208px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>11</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Invio dell'iscrizione al Backend</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-def">sendSubscriptionToBackEnd</span>(<span class="cm-def">subscription</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">fetch</span>(<span class="cm-string">'/api/iscriviUtente/'</span>, {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">method</span>: <span class="cm-string">'POST'</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">headers</span>: {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">'Content-Type'</span>: <span class="cm-string">'application/json'</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-property">body</span>: <span class="cm-variable">JSON</span>.<span class="cm-property">stringify</span>(<span class="cm-variable-2">subscription</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  })</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//...</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="height: 286px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><p><span>Il server gestisce l&#39;iscrizione salvando nel DB i dati contenuti nell&#39;oggetto subscription.</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="javascript"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="javascript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Node.js lato server - subscription.route</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">post</span>(<span class="cm-string">'/api/iscriviUtente/'</span>, <span class="cm-keyword">function</span> (<span class="cm-def">req</span>, <span class="cm-def">res</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">salvaIscrizioneNelDatabase</span>(<span class="cm-variable-2">req</span>.<span class="cm-property">body</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .<span class="cm-property">then</span>(<span class="cm-keyword">function</span>(<span class="cm-def">subscriptionId</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">res</span>.<span class="cm-property">setHeader</span>(<span class="cm-string">'Content-Type'</span>, <span class="cm-string">'application/json'</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">res</span>.<span class="cm-property">send</span>(<span class="cm-variable">JSON</span>.<span class="cm-property">stringify</span>({ <span class="cm-property">data</span>: { <span class="cm-property">success</span>: <span class="cm-atom">true</span> } }));</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  })</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 208px;"></div><div class="CodeMirror-gutters" style="height: 208px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p>&nbsp;</p><p><span>Fatto ciò il server conosce 3 informazioni:</span></p><ul><li><span>Endpoint assegnato all&#39;utente</span></li><li><span>Chiave pubblica</span></li></ul><p><span>Quando il server vuole </span><strong><span>inviare una notifica a un client</span></strong><span> si esegue il percorso inverso, tenendo cura dell&#39;utilizzo delle chiavi da parte del server per firmare il proprio PUSH, che verrebbe altrimenti scartato dal Client </span></p><p><img src=".\assets\notifica.png" referrerpolicy="no-referrer" alt="notifica"></p><h4 id='544---controllo-bash'><span>5.4.4 - Controllo Bash</span></h4><p><span>La </span><strong><span>funzionalità principale della PWA di amministrazione</span></strong><span> è quella di eseguire script che comandano la bash del Server di Linux.</span></p><p><span>Lato server (node.js) è presente una route dedicata e messa in sicurezza con password.</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>9</div></div><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>10</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div style="position: relative;" class="CodeMirror-activeline"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//Classe node-cmd, interfaccia con la bash di linux</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">var</span> <span class="cm-def">cmd</span><span class="cm-operator">=</span><span class="cm-variable">require</span>(<span class="cm-string">'node-cmd'</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><div class="" style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">use</span>(<span class="cm-variable">authenticator</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">post</span>(<span class="cm-string">'/api/admin/esegui_comando'</span>, <span class="cm-keyword">function</span> (<span class="cm-def">req</span>, <span class="cm-def">res</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">let</span> <span class="cm-def">comando_richiesto</span> <span class="cm-operator">=</span> <span class="cm-variable-2">req</span>.<span class="cm-property">body</span>.<span class="cm-property">cmd</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">cmd</span>.<span class="cm-property">run</span>(<span class="cm-variable-2">comando_richiesto</span>, <span class="cm-keyword">function</span>(<span class="cm-def">err</span>, <span class="cm-def">data</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">'comando eseguito :'</span> <span class="cm-operator">+</span> <span class="cm-variable-2">data</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  );</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 260px;"></div><div class="CodeMirror-gutters" style="height: 260px; left: 0px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><h3 id='55---proxy-e-sicurezza'><span>5.5 - Proxy e Sicurezza</span></h3><p><span>Il Proxy logico è rappresentato da un intermediario Node.</span></p><p><span>Il Proxy si antepone ad ogni chiamata : se proviene da un indirizzo ip locale lo lascia passare, altrimenti esegue un controllo e una forzatura al passaggio ad HTTPS se questo non è impiegato</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//bin - Node.js</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">enable</span>(<span class="cm-string">'trust proxy'</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">app</span>.<span class="cm-property">use</span>((<span class="cm-def">req</span>, <span class="cm-def">res</span>, <span class="cm-def">next</span>) <span class="cm-operator">=&gt;</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">req</span>.<span class="cm-property">secure</span> <span class="cm-operator">?</span> <span class="cm-variable-2">next</span>() : <span class="cm-variable-2">res</span>.<span class="cm-property">redirect</span>(<span class="cm-string">'https://'</span> <span class="cm-operator">+</span> <span class="cm-variable-2">req</span>.<span class="cm-property">headers</span>.<span class="cm-property">host</span> <span class="cm-operator">+</span> <span class="cm-variable-2">req</span>.<span class="cm-property">url</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="height: 130px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><blockquote><p><span>Attenzione questo proxy non è da confondersi con il proxy scritto in Python (vedasi sezione dedicata 5.2.2) per la ricezione CoAP nel caso dell&#39;utilizzo di VLAN.</span></p></blockquote><p>&nbsp;</p><p><span>La sicurezza viene mantenuta in generale utilizzando :</span></p><figure><table><thead><tr><th><span>Lato Server</span></th><th><span>Lato Client</span></th></tr></thead><tbody><tr><td><span>JWT</span></td><td><span>HTTP-Only-Cookie</span></td></tr><tr><td><a href='https://github.com/wildLori/Pino#jwt'><span>Già ampiamente discusso</span></a><span> (rimando a una documentazione precedente di Belfanti Lorenzo) , utilizzato primariamente per evitare continue chiamate al DB.</span></td><td><span>Tipologia di Cookie che non è soggetta ad attacchi XSS</span></td></tr></tbody></table></figure><p>&nbsp;</p><h3 id='56---backup'><span>5.6 - Backup</span></h3><p><span>Nella situazione presa in esame è bene notare come il </span><strong><span>supporto di memorizzazione</span></strong><span> SDHC sia </span><strong><span>estremamente fragile in caso di elevate operazioni R/W</span></strong><span>.</span></p><p><span>In funzione di ciò è necessario prevedere un piano di backup dei dati da effettuarsi su supporto esterno.</span></p><blockquote><p><span>In generale un piano di backup è da prevedersi in ogni tipo di progetto commerciale / enterprise</span></p></blockquote><h4 id='561---script--automatizzazione'><span>5.6.1 - Script &amp; Automatizzazione</span></h4><p><em><span>Di seguito il codice dello script per eseguire il backup automaticamente</span></em></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Script Backup : Variabili</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">DATE</span><span class="cm-operator">=</span><span class="cm-quote">$(date +%Y-%m-%d-%H%M)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">BACKUP_DIR</span><span class="cm-operator">=</span><span class="cm-string">"/home/pi/backups"</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">SOURCE</span><span class="cm-operator">=</span><span class="cm-string">"/home/homeassistant/.homeassistant"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="height: 130px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><figure><table><thead><tr><th><span>Elemento</span></th><th><span>Descrizione Elemento</span></th></tr></thead><tbody><tr><td><span>DATE</span></td><td><span>Data di esecuzione del Backup</span></td></tr><tr><td><span>BACKUP_DIR</span></td><td><span>Percorso dove viene eseguito il Backup</span></td></tr><tr><td><span>SOURCE</span></td><td><span>Cartella sottoposta a backup</span></td></tr></tbody></table></figure><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Script Backup : Compressione e Scelta File</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> tar <span class="cm-attribute">-czpf</span> <span class="cm-def">$BACKUP_DIR</span>/backup-<span class="cm-def">$DATE</span>.tar.gz <span class="cm-def">$SOURCE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">find</span> <span class="cm-def">$BACKUP_DIR</span> <span class="cm-attribute">-type</span> f <span class="cm-attribute">-mtime</span> <span class="cm-operator">+</span><span class="cm-number">30</span> <span class="cm-attribute">-delete</span> </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 78px;"></div><div class="CodeMirror-gutters" style="height: 78px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><figure><table><thead><tr><th><span>Elemento</span></th><th><span>Descrizione Elemento</span></th></tr></thead><tbody><tr><td><span>-c</span></td><td><span>Creazione Archivio</span></td></tr><tr><td><span>-z</span></td><td><span>Compressione con gzip</span></td></tr><tr><td><span>-p</span></td><td><span>Mantenimento permessi di accesso</span></td></tr><tr><td><span>-f</span></td><td><span>Scrittura su file</span></td></tr><tr><td><span>-delete</span></td><td><span>Eliminazione di file più vecchi di 30gg</span></td></tr></tbody></table></figure><p><span>Per rendere il file eseguibilie automaticamente si impiega l&#39;utilità </span><strong><span>crontab</span></strong><span> di Linux.</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Aggiunta permesso di esecuzione script per l'utente pi</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> <span class="cm-builtin">chmod</span> <span class="cm-operator">+</span>x ha_backup.sh</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 52px;"></div><div class="CodeMirror-gutters" style="height: 52px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#Riga da inserire in Crontab</span></span></pre></div><div style="position: relative;" class=""><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">0</span> <span class="cm-number">2</span> * * * /MIOPERCORSO/ha_backup.sh</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 52px;"></div><div class="CodeMirror-gutters" style="height: 52px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><h2 id='6---roadmap-successiva'><span>6 - Roadmap successiva</span></h2><ul><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p>&nbsp;</p></li><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p><span>Ricollocamento </span><strong><span>Macchina Server Locale</span></strong></p></li><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p><span>Installazione in </span><strong><span>Container</span></strong></p></li><li class='md-task-list-item task-list-item task-list-done' ><input type='checkbox' checked/><p><span>Migrazione </span><strong><span>DB in Cloud</span></strong></p></li><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p><span>Ottenimento </span><strong><span>informazioni tramite Richiesta ad Alexa</span></strong></p></li><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p><strong><span>Esportazione</span></strong><span> </span><strong><span>con Excel</span></strong></p></li></ul><h3 id='61---ri-collocamento-server-locale'><span>6.1 - Ri-collocamento Server Locale</span></h3><p><span>Con l&#39;arrivo della </span><strong><span>stagione estiva</span></strong><span> è necessario spostare la collocazione fisica del Server per evitare </span><strong><span>problemi termici.</span></strong>
<span>Nell&#39;abitazione il Raspberry è attualmente in una zona esposta al calore del sole.</span>
<span>La zona più consigliabile per il periodo estivo è un luogo con temperatura inferiore ove però il range della rete non arriva.</span></p><p><span>Le soluzioni sono due:</span></p><figure><table><thead><tr><th><span>Soluzione</span></th><th><span>Implicazioni</span></th></tr></thead><tbody><tr><td><span>Estensione VLAN</span></td><td><span>Utilizzo Proxy per forwarding dei messaggi al server principale</span></td></tr><tr><td><span>Cavo Ethernet Aggiuntivo</span></td><td><span>I tubi per il passaggio dei cavi sono attualmente saturi. </span><br></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></figure><h3 id='62---installazione-in-container'><span>6.2 - Installazione in Container</span></h3><p><span>Nella sezione dedicata al Backup sono indicate le procedure per eseguire periodicamente un backup tramite gzip.</span></p><p><span>L&#39;utilizzo di una versione Containerizzata (ad esempio con Docker) di HA-Core ha vantaggi quando si vogliono effettuare operazioni di:</span></p><ul><li><p><span>Migrazione</span></p></li><li><p><span>Ripristino</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 11px; left: 32px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 28px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -28px; width: 28px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">--init</span> <span class="cm-attribute">-d</span> \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-attribute">--name</span> homeassistant \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-attribute">--restart</span><span class="cm-operator">=</span>unless-stopped \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-attribute">-v</span> /etc/localtime:/etc/localtime:ro \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-attribute">-v</span> /PATH_TO_YOUR_CONFIG:/config \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-attribute">--network</span><span class="cm-operator">=</span>host \</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -28px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  homeassistant/raspberrypi4-homeassistant:stable</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 182px;"></div><div class="CodeMirror-gutters" style="height: 182px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 27px;"></div></div></div></div></pre><p>&nbsp;</p></li></ul><h3 id='63---migrazione-db-in-cloud'><span>6.3 - Migrazione DB in Cloud</span></h3><p><span>La migrazione del DB in Cloud comporta due importanti vantaggi :</span></p><ul><li><p><span>Facilitazione del </span><strong><span>Backup</span></strong></p></li><li><p><span>Ammortizzazione </span><strong><span>impatto delle operazioni R/W</span></strong><span> sulla memoria SDHC di Raspberry </span></p><blockquote><p><span>NOTA : Tutti i dati devono passare come stream in RAM al fine di evitare le operazioni di lettura / scrittura</span></p></blockquote></li></ul><p><span>La scelta dell&#39;hosting può variare tra una serie di soluzioni tra cui:</span></p><ul><li><strong><span>AWS</span></strong></li><li><strong><span>Azure SQL</span></strong></li><li><strong><span>Airtable</span></strong></li></ul><blockquote><p><span>NOTA : è sufficiente richiedere un </span><strong><span>DaaS</span></strong><span> (Database As A Service) poichè non vi è la necessità di spostare tutta la logica su un </span><strong><span>VPS</span></strong><span> finchè vi è una macchina server sufficientemente performante in locale.</span></p></blockquote><h3 id='64---richieste-esplicite-verso-alexa'><span>6.4 - Richieste esplicite verso Alexa</span></h3><p><span>L&#39;implementazione attuale permette di eseguire un annuncio vocale con Alexa tramite i server di Amazon. </span>
<span>Per un aggiornamento futuro si intende aggiungere la possibilità di </span><strong><span>effettuare richieste ad Alexa</span></strong><span> come per esempio </span></p><blockquote><p><span>&quot;Alexa, quanto sto consumando attualmente?&quot;  </span></p><p><span>&quot;Alexa, accendi </span><em><span>apparecchio X</span></em><span> quando si attiva la fascia F3&quot;</span></p></blockquote><p><span>Implementare questa funzionalità significa portare il canale di comunicazione ad essere bi-direzionale : </span></p><p><img src=".\assets\alexa.png" referrerpolicy="no-referrer" alt="alexa"></p><ul><li><span>Server Personale -&gt; Alexa (attuale)</span></li><li><span>Alexa -&gt; Server Personale (previsto)</span></li></ul><p><span>Per farlo è necessario </span><strong><a href='https://developer.amazon.com/it-IT/alexa/alexa-skills-kit'><span>creare una skill Alexa personale</span></a></strong><span>. </span></p><ul><li><p><span>Account AWS Developer</span></p></li><li><p><span>Lambda function hostate su AWS</span></p><h3 id='65---esportazione-con-excel'><span>6.5 - Esportazione con Excel</span></h3><p><span>Nonostante fosse uno dei primi obiettivi per questioni di tempo non è stato possibile implementare la funzionalità di esportazione con Excel.</span></p><p>&nbsp;</p><p><span>Implementare questa funzionalità richiede:</span></p><ul><li><span>Libreria di Supporto all&#39;esportazione </span><a href='https://www.npmjs.com/package/excel4node'><span>Excel con Node.js</span></a></li><li><span>Query sul DB che ricavino</span></li><li><span>Layout di Esportazione (l&#39;alternativa è quella di esportare in .CSV)</span></li></ul></li></ul><h2 id='7---note--conclusioni'><span>7 - Note &amp; Conclusioni</span></h2><p><span>A livello logico si può quindi così riassumere la struttura del sistema:</span></p><p><img src=".\assets\rete+logico.svg" alt="rete+logico" style="zoom:75%;" /></p><ul><li><span>Linee tratteggiate : Flusso logico</span></li><li><span>Linee rette : Flusso fisico</span></li></ul><blockquote><p><span>E&#39; importante che al termine della lettura sia chiaro:</span></p><ul><li><span>Ruolo di ogni attore</span></li><li><span>Funzionamento (ad alto livello) di ogni attore</span></li></ul></blockquote><h3 id='71---strumenti-software-impiegati'><span>7.1 - Strumenti Software Impiegati</span></h3><figure><table><thead><tr><th><span>Strumento</span></th><th><span>Descrizione Utilizzo</span></th></tr></thead><tbody><tr><td><span>Visual Studio Code</span></td><td><span>Scrittura Codice</span></td></tr><tr><td><span>Chrome DevTools</span></td><td><span>Debug e Testing in-browser</span></td></tr><tr><td><span>Postman</span></td><td><span>Testing HTTP</span></td></tr><tr><td><span>Wireshark</span></td><td><span>Monitoring traffico di rete</span></td></tr><tr><td><span>WinScp</span></td><td><span>Accesso via SFTP grafico</span></td></tr><tr><td><span>Nano</span></td><td><span>Editor di Testo via Terminale</span></td></tr><tr><td><span>DBBrowser for Sqlite</span></td><td><span>Editor Grafico per DB SQLite</span></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></figure><figure><table><thead><tr><th><span>Strumento</span></th><th><span>Descrizione Utilizzo</span></th></tr></thead><tbody><tr><td><span>Typora</span></td><td><span>Scrittura Documentazione</span></td></tr><tr><td><span>Draw.io</span></td><td><span>Creazione Diagrammi</span></td></tr></tbody></table></figure><h3 id='72---fonti'><span>7.2 - Fonti</span></h3><ul><li><p><span>APIs</span></p><ul><li><a href='https://developers.home-assistant.io/docs/api/rest/'><span>Reference API Home Assistant</span></a></li><li><a href='https://shelly-api-docs.shelly.cloud/'><span>Reference API Shelly IoT</span></a></li></ul></li><li><p><span>Reference Progressive Web App</span></p><ul><li><span>Protocollo WebPush </span><a href='https://datatracker.ietf.org/doc/html/draft-ietf-webpush-protocol'><span>da IETF.org</span></a><span> </span></li><li><span>Reference </span><a href='https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API'><span>Service Worker (MDN Web Docs)</span></a></li><li><span>Reference </span><a href='https://developer.mozilla.org/en-US/docs/Web/API/Push_API'><span>WebPushAPI (MDN Web Docs)</span></a></li><li><span>Cookbook </span><a href='https://github.com/mozilla/serviceworker-cookbook/'><span>Service Worker (Github)</span></a></li></ul></li><li><p><span>Home Assistant</span></p><ul><li><a href='https://developers.home-assistant.io/'><span>Developer Documentation HASSIO</span></a></li></ul></li><li><p><span>Raspberry PI</span></p><ul><li><a href='https://www.raspberrypi.org/documentation/'><span>Raspberry PI Official Docs</span></a></li></ul></li><li><p><span>Sqlite</span></p><ul><li><a href='https://www.sqlite.org/whentouse.html'><span>Use-Cases SQLite</span></a></li></ul></li><li><p><span>Protocolli Comunicazione</span></p><ul><li><a href='https://datatracker.ietf.org/meeting/103/materials/slides-103-maprg-evaluating-the-performance-of-coap-mqtt-and-http-in-vehicular-scenarios-jaime-jimenez-00'><span>Confronto MQTT, HTTP, COAP</span></a></li><li><a href='https://www.rfwireless-world.com/Terminology/Difference-between-CoAP-and-HTTP.html'><span>CoAP vs HTTP</span></a></li></ul></li></ul><p>&nbsp;</p></div></div>
</body>
</html>